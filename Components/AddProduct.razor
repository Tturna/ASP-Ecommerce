@using ASP_Ecommerce.Models
@using ASP_Ecommerce.Services
@inject ApplicationDbContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider

<h3>Add Product</h3>

@if (_message != string.Empty)
{
    <p class="alert @_alertClass">@_message</p>
}

<div>
    @* TODO: Custom CSS *@
    <EditForm Model="Model" OnValidSubmit="Submit" FormName="AddProduct" class="border-light">
        @* Antiforgery stuff is added by default? *@
        <DataAnnotationsValidator/>
        <ValidationSummary class="text-danger"/>
        <div class="form-group">
            <label class="form-label">Product Name</label>
            <InputText @bind-Value="Model.Name" class="form-control"/>
        </div>
        <div class="form-group">
            <label class="form-label">Short Description</label>
            <InputText @bind-Value="Model.ShortDescription" class="form-control"/>
        </div>
        <div class="form-group">
            <label class="form-label">Price</label>
            <InputNumber @bind-Value="Model.Price" class="form-control"/>
        </div>
        <div class="form-group">
            <label class="form-label">Category Path</label>
            <InputText @bind-Value="Model.CategoryPath" class="form-control"/>
        </div>
        <div class="form-group">
            <label class="form-label">Image Url</label>
            <InputText @bind-Value="Model.ImageUrl" class="form-control"/>
        </div>
        <button type="submit" class="btn btn-primary my-3">Add</button>
    </EditForm>
</div>

@code {
    [SupplyParameterFromForm]
    private ProductModel Model { get; set; } = new();
    
    private string _message = string.Empty;
    private string _alertClass = string.Empty;
    private UserModel _user = default!;
    private bool _isMaintainer;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        var authState = AuthenticationStateProvider.GetAuthenticationStateAsync().Result;
        var principal = authState.User;
        _user = DbContext.Users.First(u => u.UserName == principal.Identity!.Name);
        _isMaintainer = principal.IsInRole("Maintainer");
    }

    private async Task Submit()
    {
        // Product adding is done here because a controller would require a separate request
        // which wouldn't be a problem if HttpClient included the Identity cookie.
        // It can probably be added manually but it's not worth the effort rn. CBA.
        try
        {
            if (_isMaintainer)
            {
                Model.Maintainer = _user;
                Model.MaintainerId = _user.Id;
                
                // _user.MaintainerProducts.Add(Model);
            }
            
            await DbContext.Products.AddAsync(Model);
            await DbContext.SaveChangesAsync();
            _message = "Product added successfully!";
            _alertClass = "alert-success";
        }
        catch (Exception e)
        {
            _message = e.Message;
            _alertClass = "alert-danger";
        }
    }
}